<!DOCTYPE html>
<html lang="en">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<link rel="stylesheet" href="../../main.css">
		<link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/Pamishly/PamishlysPlayPlace/refs/heads/main/logo.ico">
		<title>Pamishly SS1</title>
	  </head>
  <body>
    <div class="container">
        <nav class="menu">
            <iframe src="../../navbar.html" seamless="seamless"></iframe>
        </nav>
        <main class="main">
          <div class="information">
            <h1>USB Webcam Tutorial</h1>
            <br>
            <p>Requirements:</p>
            <p>Raspberry Pi Zero 2W</p>
            <p>Camera Module of your choice</p>
            <p>Computer with SSH and <a href="https://www.raspberrypi.com/software/" style="display:inline">Raspberry Pi Imager</a></p>
            <p>This tutorial assumes you know how to SSH into the pi</p>
            <br>
            <p>First, you have to install Raspberry Pi OS Lite 64-bit on an sd card for the pi</p>
            <p>Then, plug your camera module in to the ribbin cable port and the SD card into the pi</p>
            <p>Let it boot for a minute, it will take a little longer for the first boot</p>
            <p>Then, SSH into the Pi</p>
            <br>
            <p>Once in, run these 2 commands</p>
            <div class="codeblock">
                <p><span class = purp>$</span><span class = orange> sudo apt </span><span class = white>update</span></p>
                <p><span class = purp>$</span><span class = orange> sudo apt </span><span class = white>full-upgrade</span></p>
            </div>
            <p>After that runs, reboot the Pi</p>
            <div class="codeblock">
                <p><span class = purp>$</span><span class = orange> sudo </span><span class = white>reboot</span></p>
            </div>
            <p>Once restarted run the following commands and let them install</p>
            <div class = codeblock>
              <p><span class = purp>$ echo</span><span class = green> "dtoverlay=dwc2,dr_mode=otg" </span><span class = blue>|</span><span class = orange> sudo tee </span><span class = white>-a /boot/firmware/config.txt</span></p>
              <p><span class = purp>$</span><span class = orange> sudo apt install git </span><span class = white>meson libcamera-dev libjpeg-dev</span></p>
            </div>
            <p>You may have to press <span class = white>y</span> to continue</p>
            <div class = codeblock>
              <p><span class = purp>$</span><span class = orange> git</span><span class = white> clone https://gitlab.freedesktop.org/camera/uvc-gadget.git</span></p>
              <p><span class = purp>$ cd </span><span class - white>uvc-gadget</span></p>
              <p><span class = purp>$</span><span class = orange> make </span><span class = white>uvc-gadget</span></p>
              <p><span class = purp>$ cd </span><span class = white>build</span></p>
              <p><span class = purp>$</span><span class = orange> sudo </span><span class = white>meson </span><span class = orange>install</span></p>
              <p><span class = purp>$</span><span class = orange> sudo </span><span class = white>ldconfig</span></p>
              <p><span class = purp>$</span><span class = orange> sudo nano</span><span class = white> ~/.rpi-uvc-gadget.sh</span></p>
            </div>
            <p>Then copy and paste the following into the text editor</p>
            <div class = codeblock class = white>
                  <p>#!/bin/bash</p>

                  <p># Variables we need to make things easier later on.</p>
                  
                  <p>CONFIGFS=&quot;/sys/kernel/config&quot;<br>
                  GADGET=&quot;$CONFIGFS/usb_gadget&quot;<br>
                  VID=&quot;0x0525&quot;<br>
                  PID=&quot;0xa4a2&quot;<br>
                  SERIAL=&quot;0123456789&quot;<br>
                  MANUF=$(hostname)<br>
                  PRODUCT=&quot;UVC Gadget&quot;<br>
                  BOARD=$(strings /proc/device-tree/model)<br>
                  UDC=`ls /sys/class/udc` # will identify the 'first' UDC</p>
                  
                  <p># Later on, this function is used to tell the usb subsystem that we want<br>
                  # to support a particular format, framesize and frameintervals<br>
                  create_frame() {<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    # Example usage:<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    # create_frame &lt;function name&gt; &lt;width&gt; &lt;height&gt; &lt;format&gt; &lt;name&gt; &lt;intervals&gt;</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    FUNCTION=$1<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    WIDTH=$2<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    HEIGHT=$3<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    FORMAT=$4<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    NAME=$5</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    wdir=functions/$FUNCTION/streaming/$FORMAT/$NAME/${HEIGHT}p</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    mkdir -p $wdir<br>
                        &emsp;    &emsp;    &emsp;    &emsp;    echo $WIDTH &gt; $wdir/wWidth<br>
                        &emsp;    &emsp;    &emsp;    &emsp;    echo $HEIGHT &gt; $wdir/wHeight<br>
                        &emsp;    &emsp;    &emsp;    &emsp;    echo $(( $WIDTH * $HEIGHT * 2 )) &gt; $wdir/dwMaxVideoFrameBufferSize<br>
                        &emsp;    &emsp;    &emsp;    &emsp;    cat &lt;&lt;EOF &gt; $wdir/dwFrameInterval<br>
                  $6<br>
                  EOF<br>
                  }</p>
                  
                  <p># This function sets up the UVC gadget function in configfs and binds us<br>
                  # to the UVC gadget driver.<br>
                  create_uvc() {<br>
                        &emsp;    &emsp;    &emsp;    &emsp;    CONFIG=$1<br>
                        &emsp;    &emsp;    &emsp;    &emsp;    FUNCTION=$2</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    echo &quot; Creating UVC gadget functionality : $FUNCTION&quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    mkdir functions/$FUNCTION</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    create_frame $FUNCTION 640 480 uncompressed u &quot;333333<br>
                  416667<br>
                  500000<br>
                  666666<br>
                  1000000<br>
                  1333333<br>
                  2000000<br>
                  &quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    create_frame $FUNCTION 1280 720 uncompressed u &quot;1000000<br>
                  1333333<br>
                  2000000<br>
                  &quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    create_frame $FUNCTION 1920 1080 uncompressed u &quot;2000000&quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    create_frame $FUNCTION 640 480 mjpeg m &quot;333333<br>
                  416667<br>
                  500000<br>
                  666666<br>
                  1000000<br>
                  1333333<br>
                  2000000<br>
                  &quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    create_frame $FUNCTION 1280 720 mjpeg m &quot;333333<br>
                  416667<br>
                  500000<br>
                  666666<br>
                  1000000<br>
                  1333333<br>
                  2000000<br>
                  &quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    create_frame $FUNCTION 1920 1080 mjpeg m &quot;333333<br>
                  416667<br>
                  500000<br>
                  666666<br>
                  1000000<br>
                  1333333<br>
                  2000000<br>
                  &quot;</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    mkdir functions/$FUNCTION/streaming/header/h<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    cd functions/$FUNCTION/streaming/header/h<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    ln -s ../../uncompressed/u<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    ln -s ../../mjpeg/m<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    cd ../../class/fs<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    ln -s ../../header/h<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    cd ../../class/hs<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    ln -s ../../header/h<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    cd ../../class/ss<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    ln -s ../../header/h<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    cd ../../../control<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    mkdir header/h<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    ln -s header/h class/fs<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    ln -s header/h class/ss<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    cd ../../../</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    # This configures the USB endpoint to allow 3x 1024 byte packets per<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    # microframe, which gives us the maximum speed for USB 2.0. Other<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    # valid values are 1024 and 2048, but these will result in a lower<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    # supportable framerate.<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    echo 2048 &gt; functions/$FUNCTION/streaming_maxpacket</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    ln -s functions/$FUNCTION configs/c.1<br>
                  }</p>
                  
                  <p># This loads the module responsible for allowing USB Gadgets to be<br>
                  # configured through configfs, without which we can't connect to the<br>
                  # UVC gadget kernel driver<br>
                  echo &quot;Loading composite module&quot;<br>
                  modprobe libcomposite</p>
                  
                  <p># This section configures the gadget through configfs. We need to<br>
                  # create a bunch of files and directories that describe the USB<br>
                  # device we want to pretend to be.</p>
                  
                  <p>if<br>
                  [ ! -d $GADGET/g1 ]; then<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    echo &quot;Detecting platform:&quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    echo &quot; board : $BOARD&quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    echo &quot; udc : $UDC&quot;</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    echo &quot;Creating the USB gadget&quot;</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    echo &quot;Creating gadget directory g1&quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    mkdir -p $GADGET/g1</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    cd $GADGET/g1<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    if<br>
                  [ $? -ne 0 ]; then<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    &emsp;    &emsp;    &emsp;    echo &quot;Error creating usb gadget in configfs&quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    &emsp;    &emsp;    &emsp;    exit 1;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    else<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    &emsp;    &emsp;    &emsp;    echo &quot;OK&quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    fi</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    echo &quot;Setting Vendor and Product ID's&quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    echo $VID &gt; idVendor<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    echo $PID &gt; idProduct<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    echo &quot;OK&quot;</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    echo &quot;Setting English strings&quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    mkdir -p strings/0x409<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    echo $SERIAL &gt; strings/0x409/serialnumber<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    echo $MANUF &gt; strings/0x409/manufacturer<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    echo $PRODUCT &gt; strings/0x409/product<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    echo &quot;OK&quot;</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    echo &quot;Creating Config&quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    mkdir configs/c.1<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    mkdir configs/c.1/strings/0x409</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    echo &quot;Creating functions...&quot;</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    create_uvc configs/c.1 uvc.0</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    echo &quot;OK&quot;</p>
                  
                  <p>&emsp;    &emsp;    &emsp;    &emsp;    echo &quot;Binding USB Device Controller&quot;<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    echo $UDC &gt; UDC<br>
                  &emsp;    &emsp;    &emsp;    &emsp;    echo &quot;OK&quot;<br>
                  fi</p>
                  
                  <p># Run uvc-gadget. The -c flag sets libcamera as a source, arg 0 selects<br>
                  # the first available camera on the system. All cameras will be listed,<br>
                  # you can re-run with -c n to select camera n or -c ID to select via<br>
                  # the camera ID.<br>
                  uvc-gadget -c 0 uvc.0</p>
            </div>
          </div>
        </main>
    </div>
  </body>
</html>