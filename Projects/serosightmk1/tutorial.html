<!DOCTYPE html>
<html lang="en">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<link rel="stylesheet" href="../../main.css">
		<link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/Pamishly/PamishlysPlayPlace/refs/heads/main/logo.ico">
		<title>Pamishly SS1</title>
	  </head>
  <body>
    <div class="container">
        <nav class="menu">
            <iframe src="../../navbar.html" seamless="seamless"></iframe>
        </nav>
        <main class="main">
          <div class="information">
            <h1>USB Webcam Tutorial</h1>
            <br>
            <p>Requirements:</p>
            <p>Raspberry Pi Zero 2W</p>
            <p>Camera Module of your choice</p>
            <p>Computer with SSH and <a href="https://www.raspberrypi.com/software/" style="display:inline">Raspberry Pi Imager</a></p>
            <p>This tutorial assumes you know how to SSH into the pi</p>
            <br>
            <p>First, you have to install Raspberry Pi OS Lite 64-bit on an sd card for the pi</p>
            <p>Then, plug your camera module in to the ribbin cable port and the SD card into the pi</p>
            <p>Let it boot for a minute, it will take a little longer for the first boot</p>
            <p>Then, SSH into the Pi</p>
            <br>
            <p>Once in, run these 2 commands</p>
            <div class="codeblock">
                <p><span class = purp>$</span><span class = orange> sudo apt </span><span class = white>update</span></p>
                <p><span class = purp>$</span><span class = orange> sudo apt </span><span class = white>full-upgrade</span></p>
            </div>
            <p>After that runs, reboot the Pi</p>
            <div class="codeblock">
                <p><span class = purp>$</span><span class = orange> sudo </span><span class = white>reboot</span></p>
            </div>
            <p>Once restarted run the following commands and let them install</p>
            <div class = codeblock>
              <p><span class = purp>$ echo</span><span class = green> "dtoverlay=dwc2,dr_mode=otg" </span><span class = blue>|</span><span class = orange> sudo tee </span><span class = white>-a /boot/firmware/config.txt</span></p>
              <p><span class = purp>$</span><span class = orange> sudo apt install git </span><span class = white>meson libcamera-dev libjpeg-dev</span></p>
            </div>
            <p>You may have to press <span class = white>y</span> to continue</p>
            <div class = codeblock>
              <p><span class = purp>$</span><span class = orange> git</span><span class = white> clone https://gitlab.freedesktop.org/camera/uvc-gadget.git</span></p>
              <p><span class = purp>$ cd </span><span class - white>uvc-gadget</span></p>
              <p><span class = purp>$</span><span class = orange> make </span><span class = white>uvc-gadget</span></p>
              <p><span class = purp>$ cd </span><span class = white>build</span></p>
              <p><span class = purp>$</span><span class = orange> sudo </span><span class = white>meson </span><span class = orange>install</span></p>
              <p><span class = purp>$</span><span class = orange> sudo </span><span class = white>ldconfig</span></p>
              <p><span class = purp>$</span><span class = orange> sudo nano</span><span class = white> ~/.rpi-uvc-gadget.sh</span></p>
            </div>
            <p>Then copy and paste the following into the text editor</p>
            <div class = codeblock class = white>

                  <span class="token comment"># Variables we need to make things easier later on.</span>

                  <span class="token assign-left variable">CONFIGFS</span><span class="token operator">=</span><span class="token string">"/sys/kernel/config"</span>
                  <span class="token assign-left variable">GADGET</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$CONFIGFS</span>/usb_gadget"</span>
                  <span class="token assign-left variable">VID</span><span class="token operator">=</span><span class="token string">"0x0525"</span>
                  <span class="token assign-left variable">PID</span><span class="token operator">=</span><span class="token string">"0xa4a2"</span>
                  <span class="token assign-left variable">SERIAL</span><span class="token operator">=</span><span class="token string">"0123456789"</span>
                  <span class="token assign-left variable">MANUF</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">hostname</span><span class="token variable">)</span></span>
                  <span class="token assign-left variable">PRODUCT</span><span class="token operator">=</span><span class="token string">"UVC Gadget"</span>
                  <span class="token assign-left variable">BOARD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>strings /proc/device-tree/model<span class="token variable">)</span></span>
                  <span class="token assign-left variable">UDC</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> /sys/class/udc<span class="token variable">`</span></span> <span class="token comment"># will identify the 'first' UDC</span>
                  
                  <span class="token comment"># Later on, this function is used to tell the usb subsystem that we want</span>
                  <span class="token comment"># to support a particular format, framesize and frameintervals</span>
                  <span class="token function-name function">create_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment"># Example usage:</span>
                        <span class="token comment"># create_frame &lt;function name&gt; &lt;width&gt; &lt;height&gt; &lt;format&gt; &lt;name&gt; &lt;intervals&gt;</span>
                  
                        <span class="token assign-left variable">FUNCTION</span><span class="token operator">=</span><span class="token variable">$1</span>
                        <span class="token assign-left variable">WIDTH</span><span class="token operator">=</span><span class="token variable">$2</span>
                        <span class="token assign-left variable">HEIGHT</span><span class="token operator">=</span><span class="token variable">$3</span>
                        <span class="token assign-left variable">FORMAT</span><span class="token operator">=</span><span class="token variable">$4</span>
                        <span class="token assign-left variable">NAME</span><span class="token operator">=</span><span class="token variable">$5</span>
                  
                        <span class="token assign-left variable">wdir</span><span class="token operator">=</span>functions/<span class="token variable">$FUNCTION</span>/streaming/<span class="token variable">$FORMAT</span>/<span class="token variable">$NAME</span>/<span class="token variable">${HEIGHT}</span>p
                  
                        <span class="token function">mkdir</span> -p <span class="token variable">$wdir</span>
                        <span class="token builtin class-name">echo</span> <span class="token variable">$WIDTH</span> <span class="token operator">&gt;</span> <span class="token variable">$wdir</span>/wWidth
                        <span class="token builtin class-name">echo</span> <span class="token variable">$HEIGHT</span> <span class="token operator">&gt;</span> <span class="token variable">$wdir</span>/wHeight
                        <span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">$((</span> $WIDTH <span class="token operator">*</span> $HEIGHT <span class="token operator">*</span> <span class="token number">2</span> <span class="token variable">))</span></span> <span class="token operator">&gt;</span> <span class="token variable">$wdir</span>/dwMaxVideoFrameBufferSize
                        <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> <span class="token variable">$wdir</span>/dwFrameInterval</span>
                  <span class="token variable">$6</span>
                  EOF</span>
                  <span class="token punctuation">}</span>
                  
                  <span class="token comment"># This function sets up the UVC gadget function in configfs and binds us</span>
                  <span class="token comment"># to the UVC gadget driver.</span>
                  <span class="token function-name function">create_uvc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token assign-left variable">CONFIG</span><span class="token operator">=</span><span class="token variable">$1</span>
                        <span class="token assign-left variable">FUNCTION</span><span class="token operator">=</span><span class="token variable">$2</span>
                  
                        <span class="token builtin class-name">echo</span> <span class="token string">"	Creating UVC gadget functionality : <span class="token variable">$FUNCTION</span>"</span>
                        <span class="token function">mkdir</span> functions/<span class="token variable">$FUNCTION</span>
                  
                        create_frame <span class="token variable">$FUNCTION</span> <span class="token number">640</span> <span class="token number">480</span> uncompressed u <span class="token string">"333333
                  416667
                  500000
                  666666
                  1000000
                  1333333
                  2000000
                  "</span>
                        create_frame <span class="token variable">$FUNCTION</span> <span class="token number">1280</span> <span class="token number">720</span> uncompressed u <span class="token string">"1000000
                  1333333
                  2000000
                  "</span>
                        create_frame <span class="token variable">$FUNCTION</span> <span class="token number">1920</span> <span class="token number">1080</span> uncompressed u <span class="token string">"2000000"</span>
                        create_frame <span class="token variable">$FUNCTION</span> <span class="token number">640</span> <span class="token number">480</span> mjpeg m <span class="token string">"333333
                  416667
                  500000
                  666666
                  1000000
                  1333333
                  2000000
                  "</span>
                        create_frame <span class="token variable">$FUNCTION</span> <span class="token number">1280</span> <span class="token number">720</span> mjpeg m <span class="token string">"333333
                  416667
                  500000
                  666666
                  1000000
                  1333333
                  2000000
                  "</span>
                        create_frame <span class="token variable">$FUNCTION</span> <span class="token number">1920</span> <span class="token number">1080</span> mjpeg m <span class="token string">"333333
                  416667
                  500000
                  666666
                  1000000
                  1333333
                  2000000
                  "</span>
                  
                        <span class="token function">mkdir</span> functions/<span class="token variable">$FUNCTION</span>/streaming/header/h
                        <span class="token builtin class-name">cd</span> functions/<span class="token variable">$FUNCTION</span>/streaming/header/h
                        <span class="token function">ln</span> -s <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/uncompressed/u
                        <span class="token function">ln</span> -s <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/mjpeg/m
                        <span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/class/fs
                        <span class="token function">ln</span> -s <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/header/h
                        <span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/class/hs
                        <span class="token function">ln</span> -s <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/header/h
                        <span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/class/ss
                        <span class="token function">ln</span> -s <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/header/h
                        <span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/control
                        <span class="token function">mkdir</span> header/h
                        <span class="token function">ln</span> -s header/h class/fs
                        <span class="token function">ln</span> -s header/h class/ss
                        <span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/
                  
                        <span class="token comment"># This configures the USB endpoint to allow 3x 1024 byte packets per</span>
                        <span class="token comment"># microframe, which gives us the maximum speed for USB 2.0. Other</span>
                        <span class="token comment"># valid values are 1024 and 2048, but these will result in a lower</span>
                        <span class="token comment"># supportable framerate.</span>
                        <span class="token builtin class-name">echo</span> <span class="token number">2048</span> <span class="token operator">&gt;</span> functions/<span class="token variable">$FUNCTION</span>/streaming_maxpacket
                  
                        <span class="token function">ln</span> -s functions/<span class="token variable">$FUNCTION</span> configs/c.1
                  <span class="token punctuation">}</span>
                  
                  <span class="token comment"># This loads the module responsible for allowing USB Gadgets to be</span>
                  <span class="token comment"># configured through configfs, without which we can't connect to the</span>
                  <span class="token comment"># UVC gadget kernel driver</span>
                  <span class="token builtin class-name">echo</span> <span class="token string">"Loading composite module"</span>
                  modprobe libcomposite
                  
                  <span class="token comment"># This section configures the gadget through configfs. We need to</span>
                  <span class="token comment"># create a bunch of files and directories that describe the USB</span>
                  <span class="token comment"># device we want to pretend to be.</span>
                  
                  <span class="token keyword">if</span>
                  <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token variable">$GADGET</span>/g1 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                        <span class="token builtin class-name">echo</span> <span class="token string">"Detecting platform:"</span>
                        <span class="token builtin class-name">echo</span> <span class="token string">"  board : <span class="token variable">$BOARD</span>"</span>
                        <span class="token builtin class-name">echo</span> <span class="token string">"  udc   : <span class="token variable">$UDC</span>"</span>
                  
                        <span class="token builtin class-name">echo</span> <span class="token string">"Creating the USB gadget"</span>
                  
                        <span class="token builtin class-name">echo</span> <span class="token string">"Creating gadget directory g1"</span>
                        <span class="token function">mkdir</span> -p <span class="token variable">$GADGET</span>/g1
                  
                        <span class="token builtin class-name">cd</span> <span class="token variable">$GADGET</span>/g1
                        <span class="token keyword">if</span>
                  <span class="token punctuation">[</span> <span class="token variable">$?</span> -ne <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                              <span class="token builtin class-name">echo</span> <span class="token string">"Error creating usb gadget in configfs"</span>
                              <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token keyword">else</span>
                              <span class="token builtin class-name">echo</span> <span class="token string">"OK"</span>
                        <span class="token keyword">fi</span>
                  
                        <span class="token builtin class-name">echo</span> <span class="token string">"Setting Vendor and Product ID's"</span>
                        <span class="token builtin class-name">echo</span> <span class="token variable">$VID</span> <span class="token operator">&gt;</span> idVendor
                        <span class="token builtin class-name">echo</span> <span class="token variable">$PID</span> <span class="token operator">&gt;</span> idProduct
                        <span class="token builtin class-name">echo</span> <span class="token string">"OK"</span>
                  
                        <span class="token builtin class-name">echo</span> <span class="token string">"Setting English strings"</span>
                        <span class="token function">mkdir</span> -p strings/0x409
                        <span class="token builtin class-name">echo</span> <span class="token variable">$SERIAL</span> <span class="token operator">&gt;</span> strings/0x409/serialnumber
                        <span class="token builtin class-name">echo</span> <span class="token variable">$MANUF</span> <span class="token operator">&gt;</span> strings/0x409/manufacturer
                        <span class="token builtin class-name">echo</span> <span class="token variable">$PRODUCT</span> <span class="token operator">&gt;</span> strings/0x409/product
                        <span class="token builtin class-name">echo</span> <span class="token string">"OK"</span>
                  
                        <span class="token builtin class-name">echo</span> <span class="token string">"Creating Config"</span>
                        <span class="token function">mkdir</span> configs/c.1
                        <span class="token function">mkdir</span> configs/c.1/strings/0x409
                  
                        <span class="token builtin class-name">echo</span> <span class="token string">"Creating functions..."</span>
                  
                        create_uvc configs/c.1 uvc.0
                  
                        <span class="token builtin class-name">echo</span> <span class="token string">"OK"</span>
                  
                        <span class="token builtin class-name">echo</span> <span class="token string">"Binding USB Device Controller"</span>
                        <span class="token builtin class-name">echo</span> <span class="token variable">$UDC</span> <span class="token operator">&gt;</span> UDC
                        <span class="token builtin class-name">echo</span> <span class="token string">"OK"</span>
                  <span class="token keyword">fi</span>
                  
                  <span class="token comment"># Run uvc-gadget. The -c flag sets libcamera as a source, arg 0 selects</span>
            </div>
          </div>
        </main>
    </div>
  </body>
</html>